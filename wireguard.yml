- hosts: server-1
  become: yes
 
  pre_tasks:

    - name: Create /etc/wireguard directory
      file:
        path: "{{ wireguard_path }}"
        state: directory
        owner: root
        group: root
        mode: 0600

    - name: Determine the running kernel release
      command: uname -r
      register: kernel_release
    
    - name: Install the WireGuard packages
      apt:
        package:
          - wireguard-dkms
          - wireguard-tools
          - linux-headers-{{ kernel_release.stdout }}
          - linux-headers-generic
          - wireguard
  
    - name: Generate private key
      shell: "wg genkey"
      register: wireguard_private_key_shell
      changed_when: False

    - name: Store private key
      set_fact:
        wireguard_private_key: "{{ wireguard_private_key_shell.stdout }}"

    - copy: content="{{ wireguard_private_key }}" dest="{{ wireguard_path}}/wg.key"

    - name: Private key
      debug:
        msg: "{{ wireguard_private_key }}"

    - name: Generate public key
      shell: "cat /etc/wireguard/wg.key | wg pubkey"
      register: wireguard_public_key_shell
      changed_when: False

    - name: Store public key
      set_fact:
        wireguard_public_key: "{{ wireguard_public_key_shell.stdout }}"

    - copy: content="{{ wireguard_public_key }}" dest="{{ wireguard_path}}/wg.pub"

    - name: Public key
      debug:
        msg: "{{ wireguard_public_key }}"

  roles:
    - wireguard
